<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>8-bit</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="controls">
      <div class="form-group">
        <br />
        <label for="url">Image URL</label>
        <input type="url" class="form-control" id="urlInput">
        <button id="submitImage">Upload</button>
      </div>

      <div class="form-group">
        <form>
          <label for="pixelation">Pixelation</label>
          <!-- IDEA: Sliding animation for when value changes? -->
          <div id="pixelDiv">
            <input name="slider" id="pixelation" type="range" min="1" max="100" step='.1' value="50" oninput="pixels.value=slider.value" />
            <input name="pixels" type="text" id="pixelationDisplay" value="50" for="slider" oninput="slider.value=pixels.value; updateImage()" />
            <!-- IDEA: Number field (w/ max) but without (with?) arrows -->
          </div>
        </form>
      </div>

      <div class="form-group">
        <label for="filename">File Name</label>
        <input type="text" id="filename" />
        <button id="save">Save</button>
      </div>
    </div>

    <canvas id="canvas"></canvas>
    <canvas id="hidden"></canvas>

    <script src="./8bit.js"></script>
    <script>
      // TODO: Add upload custom image option
      document.addEventListener("DOMContentLoaded", function() { updateImage() });
      document.getElementById('submitImage').addEventListener("click", updateImage);
      document.getElementById('pixelation').addEventListener("input", updateImage);

      function updateImage() {
        // pixelation value
        var val = document.getElementById('pixelation').value;
        document.getElementById('pixelationDisplay').innerHTML = val;

        // Image update
        var img = new Image();
        var defaultImage = "anon.jpg"; // default image URL
        img.onload = function() {
          eightBit(document.getElementById('canvas'), img, val)
        };
        var url = document.getElementById("urlInput").value;
        img.src = url || defaultImage;
        img.width = "500";
        img.height = "300";
        // TODO: Somehow make the image keep it's dimensions in a smaller display (export 1920 x 1080!)

        // IDEA: Instead, have the canvas cover the whole page and have a slide-
        //       out side menu that has the options (actually shows changes)
        var hiddenImage = new Image();
        hiddenImage.onload = function() {
          eightBit(document.getElementById('hidden'), hiddenImage, val)
        };
        hiddenImage.src = url || defaultImage;
      }

      function downloadCanvas(link, canvasId, filename) {
        link.href = document.getElementById(canvasId).toDataURL();
        link.download = filename;
      }

      document.getElementById('save').addEventListener('click', function() {
        var filename = document.getElementById("filename").value;
        downloadCanvas(this, 'hidden', filename + ".png");
      }, false);

      // Stops `Enter` key press (so form won't submit)
      function stopEnter(evt) {
        var evt = (evt) ? evt : ((event) ? event : null);
        var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
        if ((evt.keyCode == 13) && (node.type=="text"))  {return false;}
      }

      document.onkeypress = stopEnter;
    </script>
  </body>
</html>
